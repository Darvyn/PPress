{% extends 'base.html' %}

{% block title %}{% if article %}编辑文章{% else %}创建文章{% endif %}{% endblock %}

{% block head %}
<script src="{{ url_for('static', filename='vendor/ckeditor.js') }}"></script>
<style>
    .ck-editor__editable {
        min-height: 300px;
        max-height: 500px;
    }
    .ck-editor__editable_inline {
        padding: 0 10px;
    }
    /* 暗色模式下的编辑器样式 */
    html.dark .ck.ck-editor__main>.ck-editor__editable {
        background: #374151;
        color: #e5e7eb;
    }
    html.dark .ck.ck-editor__main>.ck-editor__editable.ck-focused {
        border-color: #3b82f6;
    }
    html.dark .ck.ck-toolbar {
        background: #1f2937;
        border-color: #374151;
    }
    html.dark .ck.ck-toolbar .ck-toolbar__items .ck-button {
        color: #e5e7eb;
    }
    html.dark .ck.ck-toolbar .ck-toolbar__items .ck-button:hover {
        background: #374151;
    }
    html.dark .ck.ck-toolbar .ck-toolbar__items .ck-button.ck-on {
        background: #374151;
        color: #3b82f6;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
            {% if article %}编辑文章{% else %}创建文章{% endif %}
        </h2>
        <form method="post" class="space-y-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    标题
                </label>
                <input type="text" name="title" required
                       value="{{ article.title if article else '' }}"
                       class="w-full px-3 py-2 border border-gray-200 dark:border-gray-600 rounded-lg 
                              focus:outline-none focus:ring-2 focus:ring-blue-500 
                              bg-white dark:bg-gray-700 
                              text-gray-900 dark:text-white 
                              placeholder-gray-400 dark:placeholder-gray-500">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    内容
                </label>
                <textarea name="content" id="editor" required>{{ article.content if article else '' }}</textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    分类
                </label>
                <select name="category" required
                        class="w-full px-3 py-2 border border-gray-200 dark:border-gray-600 rounded-lg 
                               focus:outline-none focus:ring-2 focus:ring-blue-500 
                               bg-white dark:bg-gray-700 
                               text-gray-900 dark:text-white">
                    {% for category in categories %}
                    <option value="{{ category.id }}" 
                            {% if article and article.category_id == category.id %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    标签
                </label>
                <div class="flex flex-wrap gap-2 mb-2">
                    {% for tag in random_tags %}
                    <button type="button"
                            onclick="addTag(this.textContent.trim())"
                            class="px-3 py-1 text-sm bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 
                                   rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 
                                   transition-colors duration-200">
                        {{ tag.name }}
                    </button>
                    {% endfor %}
                </div>
                <input type="text" name="tag_names" id="tagInput"
                       value="{{ ' '.join(article.tags|map(attribute='name')) if article else '' }}"
                       class="w-full px-3 py-2 border border-gray-200 dark:border-gray-600 rounded-lg 
                              focus:outline-none focus:ring-2 focus:ring-blue-500 
                              bg-white dark:bg-gray-700 
                              text-gray-900 dark:text-white 
                              placeholder-gray-400 dark:placeholder-gray-500"
                       placeholder="输入标签，用空格分隔">
            </div>
            
            <div class="flex justify-end space-x-4">
                <a href="{{ url_for('blog.article', id=article.id) if article else url_for('blog.index') }}"
                   class="px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg 
                          text-gray-700 dark:text-gray-300 
                          hover:bg-gray-50 dark:hover:bg-gray-700 
                          transition-colors duration-200">
                    取消
                </a>
                <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg 
                               hover:bg-blue-700 
                               transition-colors duration-200">
                    {{ '保存修改' if article else '发布文章' }}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function addTag(tagName) {
    const input = document.getElementById('tagInput');
    const currentTags = input.value.split(' ').filter(Boolean);
    
    if (!currentTags.includes(tagName)) {
        currentTags.push(tagName);
        input.value = currentTags.join(' ');
    }
}

// 初始化编辑器
ClassicEditor
    .create(document.querySelector('#editor'), {
        toolbar: ['heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', 'blockQuote', '|', 'undo', 'redo'],
        heading: {
            options: [
                { model: 'paragraph', title: '正文', class: 'ck-heading_paragraph' },
                { model: 'heading2', view: 'h2', title: '标题2', class: 'ck-heading_heading2' },
                { model: 'heading3', view: 'h3', title: '标题3', class: 'ck-heading_heading3' }
            ]
        }
    })
    .catch(error => {
        console.error(error);
    });
</script>
{% endblock %} 